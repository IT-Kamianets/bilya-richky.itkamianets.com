
<div class="profile-page" *ngIf="product as p">
  <div class="container py-5">

    <!-- Breadcrumb -->
    <nav aria-label="breadcrumb" class="mb-4">
      <ol class="breadcrumb">
        <li class="breadcrumb-item">
          <a (click)="navigateToList()" class="breadcrumb-link">
            <i class="bi bi-house-door me-1"></i>Товари
          </a>
        </li>
        <li class="breadcrumb-item" *ngIf="p.category">
          <span>{{ p.category }}</span>
        </li>
        <li class="breadcrumb-item active" aria-current="page">{{ p.title }}</li>
      </ol>
    </nav>

    <!-- Product Hero -->
    <div class="product-hero mb-5">
      <div class="row g-4">

        <!-- Image Gallery -->
        <div class="col-lg-6">
          <div class="image-gallery">
            <!-- Main Image -->
            <div class="main-image-container">
              <img [src]="selectedImage" [alt]="p.title" class="main-image">
              
              <!-- Badges -->
              <div class="image-badges">
                <span class="badge badge-new" *ngIf="p.isNew">Новинка</span>
                <span class="badge badge-discount" *ngIf="hasDiscount()">-{{ p.discount }}%</span>
                <span class="badge badge-out" *ngIf="!isInStock()">Немає в наявності</span>
              </div>
              
              <!-- Navigation Arrows -->
              <button class="gallery-nav gallery-prev" 
                      (click)="previousImage()" 
                      *ngIf="p.images && p.images.length > 1">
                <i class="bi bi-chevron-left"></i>
              </button>
              <button class="gallery-nav gallery-next" 
                      (click)="nextImage()" 
                      *ngIf="p.images && p.images.length > 1">
                <i class="bi bi-chevron-right"></i>
              </button>
            </div>
            
            <!-- Thumbnails -->
            <div class="thumbnails-container" *ngIf="p.images && p.images.length > 1">
              <div class="thumbnail" 
                   *ngFor="let img of p.images; let i = index"
                   [class.active]="selectedImage === img"
                   (click)="selectImage(img, i)">
                <img [src]="img" [alt]="p.title">
              </div>
            </div>
          </div>
        </div>

        <!-- Product Details -->
        <div class="col-lg-6">
          <div class="product-details">
            
            <!-- Brand & SKU -->
            <div class="product-meta mb-2" *ngIf="p.brand || p.sku">
              <span class="brand" *ngIf="p.brand">{{ p.brand }}</span>
              <span class="sku" *ngIf="p.sku">Артикул: {{ p.sku }}</span>
            </div>
            
            <!-- Title -->
            <h1 class="product-title">{{ p.title }}</h1>

            <!-- Rating & Reviews -->
            <div class="rating-section mb-3" *ngIf="p.rating">
              <div class="rating-stars">
                <i class="bi bi-star-fill" *ngFor="let s of getStars(p.rating)"></i>
                <i class="bi bi-star" *ngFor="let s of getEmptyStars(p.rating)"></i>
              </div>
              <span class="rating-text ms-2">{{ p.rating }}</span>
              <span class="reviews-count" *ngIf="p.reviews">({{ p.reviews.length }} відгуків)</span>
            </div>

            <!-- Price Section -->
            <div class="price-section mb-4">
              <div class="price-row">
                <div class="price-current" *ngIf="!hasDiscount()">${{ p.price.toFixed(2) }}</div>
                <div class="price-with-discount" *ngIf="hasDiscount()">
                  <span class="price-old">${{ p.price.toFixed(2) }}</span>
                  <span class="price-discounted">${{ getDiscountedPrice().toFixed(2) }}</span>
                </div>
              </div>
              
              <!-- Stock Status -->
              <div class="stock-status" [ngClass]="getStockClass()">
                <i class="bi" [ngClass]="{
                  'bi-check-circle-fill': isInStock() && p.stock >= 10,
                  'bi-exclamation-circle-fill': p.stock < 10 && p.stock > 0,
                  'bi-x-circle-fill': !isInStock()
                }"></i>
                <span>{{ getStockStatus() }}</span>
              </div>
            </div>

            <!-- Quick Specs -->
            <div class="quick-specs mb-4" *ngIf="p.specifications">
              <div class="spec-item" *ngFor="let spec of p.specifications | keyvalue | slice:0:3">
                <i class="bi bi-check2"></i>
                <span><strong>{{ spec.key }}:</strong> {{ spec.value }}</span>
              </div>
            </div>

            <!-- Quantity Selector -->
            <div class="quantity-section mb-4" *ngIf="isInStock()">
              <label class="quantity-label">Кількість:</label>
              <div class="quantity-controls">
                <button class="btn-quantity" (click)="decreaseQuantity()" [disabled]="quantity <= 1">
                  <i class="bi bi-dash"></i>
                </button>
                <input type="number" [(ngModel)]="quantity" class="quantity-input" min="1" [max]="p.stock" readonly>
                <button class="btn-quantity" (click)="increaseQuantity()" [disabled]="quantity >= p.stock">
                  <i class="bi bi-plus"></i>
                </button>
              </div>
            </div>

            <!-- Action Buttons -->
            <div class="action-buttons-section mb-4">
              <button class="btn btn-primary btn-lg" 
                      (click)="addToCart()" 
                      [disabled]="!isInStock()">
                <i class="bi bi-cart-plus me-2"></i>
                {{ isInStock() ? 'Додати в кошик' : 'Немає в наявності' }}
              </button>
              <button class="btn btn-icon" 
                      (click)="toggleFavorite()"
                      [class.active]="isFavorite">
                <i class="bi" [ngClass]="isFavorite ? 'bi-heart-fill' : 'bi-heart'"></i>
              </button>
              <button class="btn btn-icon" (click)="shareProduct()">
                <i class="bi bi-share"></i>
              </button>
            </div>

            <!-- Additional Info -->
            <div class="additional-info">
              <div class="info-item">
                <i class="bi bi-truck"></i>
                <div>
                  <strong>Безкоштовна доставка</strong>
                  <span>При замовленні від $50</span>
                </div>
              </div>
              <div class="info-item">
                <i class="bi bi-arrow-counterclockwise"></i>
                <div>
                  <strong>30 днів на повернення</strong>
                  <span>Без зайвих питань</span>
                </div>
              </div>
              <div class="info-item">
                <i class="bi bi-shield-check"></i>
                <div>
                  <strong>Гарантія 2 роки</strong>
                  <span>Офіційна гарантія виробника</span>
                </div>
              </div>
            </div>

          </div>
        </div>

      </div>
    </div>

    <!-- Tabs -->
    <div class="product-details-section">
      <div class="card">
        <div class="card-header">
          <ul class="nav nav-tabs card-header-tabs">
            <li class="nav-item">
              <a class="nav-link" [class.active]="activeTab === 'details'" (click)="activeTab='details'">
                <i class="bi bi-info-circle me-2"></i>Опис
              </a>
            </li>
            <li class="nav-item">
              <a class="nav-link" [class.active]="activeTab === 'specs'" (click)="activeTab='specs'">
                <i class="bi bi-list-check me-2"></i>Характеристики
              </a>
            </li>
            <li class="nav-item">
              <a class="nav-link" [class.active]="activeTab === 'reviews'" (click)="activeTab='reviews'">
                <i class="bi bi-star me-2"></i>Відгуки
                <span class="badge-count" *ngIf="p.reviews">{{ p.reviews.length }}</span>
              </a>
            </li>
          </ul>
        </div>

        <div class="card-body">

          <!-- Details Tab -->
          <div *ngIf="activeTab === 'details'" class="tab-content-section fade-in">
            <h5 class="section-heading">Детальний опис</h5>
            <p class="product-description">{{ p.description }}</p>
            
            <div class="description-details" *ngIf="p.brand">
              <h6>Про бренд {{ p.brand }}</h6>
              <p>{{ p.brand }} - провідний виробник якісних товарів з багаторічним досвідом на ринку. 
                 Компанія відома своєю увагою до деталей та інноваційними рішеннями.</p>
            </div>
          </div>

          <!-- Specifications Tab -->
          <div *ngIf="activeTab === 'specs'" class="tab-content-section fade-in">
            <h5 class="section-heading">Технічні характеристики</h5>
            <table class="table specs-table" *ngIf="p.specifications">
              <tbody>
                <tr *ngFor="let spec of p.specifications | keyvalue">
                  <td class="spec-label">{{ spec.key }}</td>
                  <td class="spec-value">{{ spec.value }}</td>
                </tr>
                <tr>
                  <td class="spec-label">Артикул</td>
                  <td class="spec-value">{{ p.sku || 'N/A' }}</td>
                </tr>
                <tr>
                  <td class="spec-label">Бренд</td>
                  <td class="spec-value">{{ p.brand || 'N/A' }}</td>
                </tr>
                <tr>
                  <td class="spec-label">Наявність</td>
                  <td class="spec-value">
                    <span class="availability-badge" [ngClass]="getStockClass()">
                      {{ getStockStatus() }}
                    </span>
                  </td>
                </tr>
              </tbody>
            </table>
          </div>

          <!-- Reviews Tab -->
          <div *ngIf="activeTab === 'reviews'" class="tab-content-section fade-in">
            <div class="reviews-header">
              <h5 class="section-heading">Відгуки покупців</h5>
              <button class="btn btn-outline-primary btn-sm" (click)="toggleReviewForm()">
                <i class="bi bi-plus-circle me-2"></i>Додати відгук
              </button>
            </div>

            <!-- Review Form -->
            <div class="review-form-container" *ngIf="showReviewForm">
              <div class="review-form">
                <h6>Ваш відгук</h6>
                <div class="form-group mb-3">
                  <label>Ім'я</label>
                  <input type="text" class="form-control" [(ngModel)]="newReview.author" placeholder="Ваше ім'я">
                </div>
                <div class="form-group mb-3">
                  <label>Оцінка</label>
                  <div class="rating-input">
                    <i class="bi" 
                       *ngFor="let star of [1,2,3,4,5]"
                       [ngClass]="star <= newReview.rating ? 'bi-star-fill' : 'bi-star'"
                       (click)="setRating(star)"></i>
                  </div>
                </div>
                <div class="form-group mb-3">
                  <label>Коментар</label>
                  <textarea class="form-control" 
                            [(ngModel)]="newReview.comment" 
                            rows="4" 
                            placeholder="Розкажіть про ваш досвід використання товару"></textarea>
                </div>
                <div class="form-actions">
                  <button class="btn btn-primary" (click)="submitReview()">Опублікувати</button>
                  <button class="btn btn-outline-secondary" (click)="toggleReviewForm()">Скасувати</button>
                </div>
              </div>
            </div>

            <!-- Reviews List -->
            <div class="reviews-list" *ngIf="p.reviews && p.reviews.length > 0">
              <div class="review-item" *ngFor="let review of p.reviews">
                <div class="review-header">
                  <div class="review-author">
                    <div class="author-avatar">{{ review.author.charAt(0).toUpperCase() }}</div>
                    <div>
                      <strong>{{ review.author }}</strong>
                      <span class="verified-badge" *ngIf="review.verified">
                        <i class="bi bi-patch-check-fill"></i> Підтверджена покупка
                      </span>
                    </div>
                  </div>
                  <div class="review-meta">
                    <div class="rating-stars small">
                      <i class="bi bi-star-fill" *ngFor="let s of getStars(review.rating)"></i>
                      <i class="bi bi-star" *ngFor="let s of getEmptyStars(review.rating)"></i>
                    </div>
                    <span class="review-date">{{ formatDate(review.date) }}</span>
                  </div>
                </div>
                <p class="review-text">{{ review.comment }}</p>
              </div>
            </div>

            <div class="no-reviews" *ngIf="!p.reviews || p.reviews.length === 0">
              <i class="bi bi-chat-left-text"></i>
              <p>Поки що немає відгуків. Станьте першим!</p>
            </div>

          </div>

        </div>
      </div>
    </div>

    <!-- Related Products -->
    <div class="related-products-section" *ngIf="relatedProducts.length > 0">
      <h3 class="section-title">
        <i class="bi bi-bag-check me-2"></i>Схожі товари
      </h3>
      <div class="row g-4">
        <div class="col-md-6 col-lg-3" *ngFor="let related of relatedProducts">
          <div class="related-product-card" (click)="navigateToProduct(related.id)">
            <div class="related-product-image">
              <img [src]="related.image" [alt]="related.title">
              <div class="related-badges">
                <span class="badge badge-new" *ngIf="related.isNew">Новинка</span>
                <span class="badge badge-discount" *ngIf="related.discount">-{{ related.discount }}%</span>
              </div>
            </div>
            <div class="related-product-info">
              <h6 class="related-product-title">{{ related.title }}</h6>
              <div class="related-product-footer">
                <span class="related-product-price">${{ related.price.toFixed(2) }}</span>
                <div class="rating-stars small" *ngIf="related.rating">
                  <i class="bi bi-star-fill"></i>
                  <span>{{ related.rating }}</span>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Back Button -->
    <div class="text-center mt-5">
      <button class="btn btn-outline-primary btn-lg" (click)="navigateToList()">
        <i class="bi bi-arrow-left me-2"></i>Повернутись до каталогу
      </button>
    </div>

  </div>
</div>

<!-- Loading State -->
<div class="container py-5 text-center" *ngIf="!product && !notFound">
  <div class="loading-spinner">
    <div class="spinner-border text-primary" role="status"></div>
    <p class="mt-3 loading-text">Завантаження товару...</p>
  </div>
</div>

<!-- Not Found State -->
<div class="container py-5 text-center" *ngIf="notFound">
  <div class="not-found-state">
    <i class="bi bi-exclamation-circle display-1 not-found-icon"></i>
    <h2 class="mt-3 not-found-title">Товар не знайдено</h2>
    <p class="not-found-text">Товар, який ви шукаєте, не існує або був видалений.</p>
    <button class="btn btn-primary btn-lg mt-3" (click)="navigateToList()">
      <i class="bi bi-grid me-2"></i>Переглянути каталог
    </button>
  </div>
</div>